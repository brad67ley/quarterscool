<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuarterNut Chat</title>
    <style>
      body {
        background-color: #ffcc00; /* Bright yellow background */
        color: #000080; /* Navy blue text */
        font-family: "Courier New", Courier, monospace;
        margin: 0;
        padding: 20px;
        text-align: center;
        transition: background-color 0.5s ease;
      }
      /* New Rainbow Mode style */
      body.rainbow-mode {
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradient-fade 15s ease infinite;
      }
      h1 {
        font-size: 48px;
        text-shadow: 2px 2px #ff0000; /* Red shadow for retro effect */
        margin-bottom: 20px;
      }
      .chat-container {
        max-width: 800px;
        margin: 0 auto;
        text-align: left;
        height: 65vh; /* Give chat a fixed height */
        overflow-y: auto; /* Allow scrolling */
        border: 2px solid #000080;
        background-color: rgba(255, 255, 255, 0.5);
        padding: 10px;
        border-radius: 10px;
      }
      .chat-message {
        background-color: #ffffff;
        padding: 10px;
        margin: 10px 0;
        border: 2px solid #000080; /* Navy blue border */
        border-radius: 10px;
        position: relative;
        word-wrap: break-word; /* Ensure long text/URLs wrap */
      }
      .chat-message strong {
        color: #000000; /* Black text for username */
      }
      .chat-message .owner-text {
        background: linear-gradient(
          90deg,
          red,
          orange,
          yellow,
          green,
          blue,
          indigo,
          violet
        );
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradient-fade 5s ease infinite;
      }
      .chat-message .piss-man-badge {
        color: #0000ff; /* Blue text for "piss man" badge */
        font-weight: bold;
        margin-left: 5px;
      }
      .chat-message .anime-girl-badge {
        color: #ff69b4; /* Pink text for "anime girl" badge */
        font-weight: bold;
        margin-left: 5px;
      }
      .chat-message .the-real-n-badge {
        background: linear-gradient(
          90deg,
          #000000,
          #ffcc00
        ); /* Black-yellow gradient */
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: gradient-fade 5s ease infinite;
        font-weight: bold;
        margin-left: 5px;
      }
      .chat-message .silly-badge {
        color: #ff69b4; /* Pink text for "silly" badge */
        font-weight: bold;
        margin-left: 5px;
      }
      @keyframes gradient-fade {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .chat-message .delete-button {
        position: absolute;
        right: 10px;
        top: 10px;
        background-color: #ff0000; /* Red button */
        color: #ffffff; /* White text */
        border: none;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 5px;
      }
      .chat-message .delete-button:hover {
        background-color: #000080; /* Navy blue on hover */
      }
      .chat-message img {
        max-width: 100%;
        max-height: 250px;
        display: block;
        margin-top: 5px;
        border-radius: 5px;
      }
      .chat-input {
        margin-top: 20px;
      }
      .chat-input input {
        padding: 10px;
        font-size: 16px;
        width: 70%;
        border: 2px solid #000080;
      }
      .chat-input button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #ff0000;
        color: #ffffff;
        border: none;
        cursor: pointer;
      }
      .chat-input button:hover {
        background-color: #000080;
      }
      .user-info {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 18px;
        color: #000080;
      }
      .sign-out-link {
        color: #000080;
        text-decoration: none;
      }
      .sign-out-link:hover {
        text-decoration: underline;
      }
      .admin-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border: 2px solid #000080;
        border-radius: 5px;
        display: none; /* Hidden by default */
        text-align: left;
      }
      .admin-controls button {
        display: block;
        margin: 5px 0;
        padding: 5px 10px;
        background-color: #ff0000;
        color: #ffffff;
        border: none;
        cursor: pointer;
      }
      .admin-controls button:hover {
        background-color: #000080;
      }
      .badge-maker {
        margin-top: 10px;
        border-top: 1px solid #000080;
        padding-top: 10px;
      }
      .badge-maker input {
        display: block;
        margin-bottom: 5px;
        width: 150px;
      }
      .global-message-text {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        color: #ff0000;
        text-shadow: 2px 2px #000080;
        z-index: 1000;
        display: none;
      }
      /* NEW: Global Image Flash Overlay */
      .global-flash-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
      }
      .global-flash-overlay img {
        max-width: 90%;
        max-height: 90%;
        border: 5px solid white;
        border-radius: 15px;
      }
      /* NEW: Joyous Cat Button */
      .joyous-cat-button {
        position: fixed;
        bottom: 15px;
        left: 15px;
        width: 100px;
        height: 100px;
        cursor: pointer;
        border-radius: 10px;
        border: 3px solid #000080;
        display: none; /* Hidden by default */
        z-index: 100;
      }
    </style>
  </head>
  <body>
    <!-- NEW: Admin controls container -->
    <div class="admin-controls" id="admin-controls">
      <button id="rainbow-toggle-button">Activate Rainbow</button>
      <button id="apple-flash-button">Flash Apple</button>
      <button id="wipe-chat-button">WIPE ALL MESSAGES</button>
      <div class="badge-maker">
        <h4>Badge Maker</h4>
        <input type="email" id="badge-user-email" placeholder="User Email" />
        <input type="text" id="badge-text" placeholder="Badge Text" />
        <input
          type="text"
          id="badge-color"
          placeholder="Badge Color (e.g. #FF0000)"
        />
        <button id="set-badge-button">Set Badge</button>
      </div>
    </div>

    <div class="user-info" id="user-info"></div>
    <div class="global-message-text" id="global-message-text"></div>
    <!-- NEW: Global Flash Overlay element -->
    <div class="global-flash-overlay" id="global-flash-overlay">
      <img id="global-flash-image" src="" alt="Global Image Flash" />
    </div>

    <h1>QuarterNut Chat</h1>
    <div class="chat-container" id="chat-container">
      <!-- Chat messages will be dynamically inserted here -->
    </div>
    <div class="chat-input">
      <input
        type="text"
        id="chat-input"
        placeholder="Type your message or paste a GIF URL..."
      />
      <button id="send-button">Send</button>
    </div>

    <!-- NEW: Joyous Cat button -->
    <img
      src="https://i.imgur.com/JI3tDkJ.jpeg"
      class="joyous-cat-button"
      id="joyous-cat-button"
      alt="Joyous Cat"
    />

    <!-- Firebase SDK -->
    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        push,
        onValue,
        remove,
        set,
      } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyChEepZh_3VrEDCiZQcR3Q6q8__f7p2mjg",
        authDomain: "quaters-5f71d.firebaseapp.com",
        projectId: "quaters-5f71d",
        storageBucket: "quaters-5f71d.firebasestorage.app",
        messagingSenderId: "895009748691",
        appId: "1:895009748691:web:73dc67aee4db1143e90626",
        measurementId: "G-7WFJZV9JWT",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      // DOM elements
      const userInfo = document.getElementById("user-info");
      const chatContainer = document.getElementById("chat-container");
      const chatInput = document.getElementById("chat-input");
      const sendButton = document.getElementById("send-button");
      const globalMessageText = document.getElementById("global-message-text");

      // NEW Admin/Special DOM elements
      const adminControls = document.getElementById("admin-controls");
      const rainbowToggleButton = document.getElementById(
        "rainbow-toggle-button"
      );
      const appleFlashButton = document.getElementById("apple-flash-button");
      const wipeChatButton = document.getElementById("wipe-chat-button");
      const badgeUserEmail = document.getElementById("badge-user-email");
      const badgeText = document.getElementById("badge-text");
      const badgeColor = document.getElementById("badge-color");
      const setBadgeButton = document.getElementById("set-badge-button");
      const globalFlashOverlay = document.getElementById(
        "global-flash-overlay"
      );
      const globalFlashImage = document.getElementById("global-flash-image");
      const joyousCatButton = document.getElementById("joyous-cat-button");

      let userBadges = {}; // Cache for custom user badges

      // --- Global Listeners ---

      // Listen for Rainbow Mode state
      const rainbowRef = ref(db, "siteState/rainbowMode");
      onValue(rainbowRef, (snapshot) => {
        const isEnabled = snapshot.val() === true;
        document.body.classList.toggle("rainbow-mode", isEnabled);
        if (rainbowToggleButton) {
          rainbowToggleButton.textContent = isEnabled
            ? "Deactivate Rainbow"
            : "Activate Rainbow";
        }
      });

      // Listen for Global Flash messages
      const globalFlashRef = ref(db, "globalFlash");
      onValue(globalFlashRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          // Only trigger if timestamp is recent (e.g., within last 5s) to avoid re-trigger on load
          if (Date.now() - data.timestamp < 5000) {
            globalFlashImage.src = data.url;
            globalFlashOverlay.style.display = "flex";
            setTimeout(() => {
              globalFlashOverlay.style.display = "none";
            }, 2000); // Hide after 2 seconds
          }
        }
      });

      // Listen for custom badge changes
      const badgesRef = ref(db, "userBadges");
      onValue(badgesRef, (snapshot) => {
        userBadges = snapshot.val() || {};
      });

      // Auth State Listener
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in
          const displayName = user.displayName || user.email;
          userInfo.innerHTML = `<a href="profile.html">${displayName}</a> | <a href="#" id="sign-out-link">Sign Out</a>`;

          const isAdmin = user.email === "brad67ley@gmail.com";
          const isFelix = user.email === "felixheffley@gmail.com";

          // Show admin controls for the owner
          if (isAdmin) {
            adminControls.style.display = "block";
          } else {
            adminControls.style.display = "none";
          }

          // Show joyous cat button for admin OR Felix
          if (isAdmin || isFelix) {
            joyousCatButton.style.display = "block";
          } else {
            joyousCatButton.style.display = "none";
          }

          loadChatMessages();

          const sendMessage = () => {
            const message = chatInput.value.trim();
            if (message) {
              push(ref(db, "messages"), {
                text: message,
                user: displayName,
                email: user.email,
                timestamp: new Date().toISOString(),
              })
                .then(() => {
                  chatInput.value = "";
                })
                .catch((error) =>
                  console.error("Error sending message: ", error)
                );
            }
          };

          sendButton.addEventListener("click", sendMessage);
          chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
          });

          const signOutLink = document.getElementById("sign-out-link");
          if (signOutLink) {
            const newSignOutLink = signOutLink.cloneNode(true);
            signOutLink.parentNode.replaceChild(newSignOutLink, signOutLink);
            newSignOutLink.addEventListener("click", (e) => {
              e.preventDefault();
              signOut(auth)
                .then(() => {
                  window.location.href = "index.html";
                })
                .catch((error) => console.error("Error signing out: ", error));
            });
          }

          // --- Admin Button Functionality ---
          rainbowToggleButton.addEventListener("click", () => {
            const currentStatus =
              document.body.classList.contains("rainbow-mode");
            set(rainbowRef, !currentStatus);
          });

          appleFlashButton.addEventListener("click", () => {
            set(globalFlashRef, {
              url: "https://img.freepik.com/free-psd/close-up-delicious-apple_23-2151868338.jpg",
              timestamp: Date.now(),
            });
          });

          wipeChatButton.addEventListener("click", () => {
            if (
              confirm(
                "ARE YOU SURE you want to delete ALL messages? This cannot be undone!"
              )
            ) {
              remove(ref(db, "messages")).catch((err) =>
                alert("Error wiping chat: " + err.message)
              );
            }
          });

          setBadgeButton.addEventListener("click", () => {
            const email = badgeUserEmail.value.trim();
            const text = badgeText.value.trim();
            const color = badgeColor.value.trim();
            if (email && text && color) {
              const sanitizedEmail = email.replace(/\./g, ","); // Firebase keys can't have '.'
              const badgeRef = ref(db, `userBadges/${sanitizedEmail}`);
              set(badgeRef, { text, color })
                .then(() => {
                  alert(`Badge set for ${email}!`);
                  badgeUserEmail.value =
                    badgeText.value =
                    badgeColor.value =
                      "";
                })
                .catch((err) => alert("Error setting badge: " + err.message));
            } else {
              alert("Please fill out all fields for the badge.");
            }
          });

          // --- Special Button Functionality ---
          joyousCatButton.addEventListener("click", () => {
            push(ref(db, "messages"), {
              text: "joyous cat",
              user: "flixheff", // Use known username
              email: "felixheffley@gmail.com", // Post as Felix
              timestamp: new Date().toISOString(),
            }).catch((error) =>
              console.error("Error sending joyous cat message: ", error)
            );
          });
        } else {
          // User is signed out, redirect to main page
          window.location.href = "index.html";
        }
      });

      function isGifUrl(url) {
        if (typeof url !== "string") return false;
        return url.toLowerCase().match(/^https?:\/\/.+\.(gif)(\?.*)?$/i);
      }

      function loadChatMessages() {
        const messagesRef = ref(db, "messages");
        onValue(
          messagesRef,
          (snapshot) => {
            const wasScrolledToBottom =
              chatContainer.scrollHeight - chatContainer.clientHeight <=
              chatContainer.scrollTop + 5;
            chatContainer.innerHTML = ""; // Clear chat container
            snapshot.forEach((childSnapshot) => {
              const message = childSnapshot.val();
              if (!message || !message.user || !message.text) return;

              const messageElement = document.createElement("div");
              messageElement.classList.add("chat-message");

              let userPrefix = "";
              const sanitizedEmail = message.email
                ? message.email.replace(/\./g, ",")
                : "";
              const customBadge = userBadges[sanitizedEmail];

              // 1. Check for a custom badge from the badge maker
              if (customBadge) {
                userPrefix = `<strong>${message.user}</strong> <span style="color: ${customBadge.color}; font-weight: bold; margin-left: 5px;">${customBadge.text}</span>: `;
              }
              // 2. Fallback to hardcoded badges
              else if (message.email === "brad67ley@gmail.com") {
                userPrefix = `<strong>${message.user}</strong> <span class="owner-text">OWNER</span>: `;
              } else if (message.email === "victors.realm1@gmail.com") {
                userPrefix = `<strong>${message.user}</strong> <span class="piss-man-badge">piss gal</span>: `;
              } else if (message.email === "jagaimoanimetitties@gmail.com") {
                userPrefix = `<strong>${message.user}</strong> <span class="anime-girl-badge">anime girl</span>: `;
              } else if (message.email === "trashcall988110@gmail.com") {
                userPrefix = `<strong>${message.user}</strong> <span class="the-real-n-badge">The Real N</span>: `;
              } else if (message.email === "felixheffley@gmail.com") {
                userPrefix = `<strong>${message.user}</strong> <span class="silly-badge">silly</span>: `;
              }
              // 3. Default user prefix
              else {
                userPrefix = `<strong>${message.user}</strong>: `;
              }

              if (isGifUrl(message.text)) {
                messageElement.innerHTML = `${userPrefix}<img src="${message.text}" alt="${message.user}'s GIF">`;
              } else {
                const textNode = document.createTextNode(message.text);
                const textSpan = document.createElement("span");
                textSpan.appendChild(textNode);
                messageElement.innerHTML = userPrefix;
                messageElement.appendChild(textSpan);
              }

              if (
                auth.currentUser &&
                auth.currentUser.email === "brad67ley@gmail.com"
              ) {
                const deleteButton = document.createElement("button");
                deleteButton.classList.add("delete-button");
                deleteButton.textContent = "Delete";
                deleteButton.addEventListener("click", () => {
                  remove(childSnapshot.ref).catch((error) =>
                    console.error("Error deleting message: ", error)
                  );
                });
                messageElement.appendChild(deleteButton);
              }

              chatContainer.appendChild(messageElement);
            });

            if (wasScrolledToBottom) {
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          },
          (error) => {
            console.error("Error fetching messages:", error);
          }
        );
      }
    </script>
  </body>
</html>
